<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ğŸ“… 28 å¤©å­¦ä¹ è®¡åˆ’ï¼ˆäº‘åŒæ­¥ï¼‰</title>
<link rel="stylesheet" href="../assets/style.css">

<style>
.dayBox {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  margin:8px 0;
  border:1px solid #ccc;
  border-radius:8px;
  background:#fafafa;
}
.done {
  background:#d4f3d4 !important;
}
.btn {
  padding:8px 12px;
  background:#4f8cff;
  color:white;
  border-radius:6px;
  cursor:pointer;
}
.stats {
  background:#f0f0f0;
  padding:10px 12px;
  border-radius:8px;
  margin-bottom:16px;
}
</style>
</head>

<body>

<a href="../index.html" class="back">â† è¿”å›é¦–é¡µ</a>
<h2>ğŸ“… 28 å¤©å­¦ä¹ è®¡åˆ’</h2>
<p>ç”¨æˆ·IDï¼š<span id="uidShort" style="font-weight:bold;"></span></p>

<div class="stats">
  <p>å·²å®Œæˆå¤©æ•°ï¼š<span id="doneCount">0</span> å¤©</p>
  <p>å‰©ä½™å¤©æ•°ï¼š<span id="leftCount">28</span> å¤©</p>
  <p>å®Œæˆç‡ï¼š<span id="percent">0</span>%</p>
</div>

<div id="planArea"></div>

<script type="module">
import { autoLogin, onUser, load, save } from "../assets/firebase.js";

let uid = null;
let plan = []; // ç»“æ„ï¼š[{day:1, done:false, time:""}, ...]

const TOTAL = 28;

// ---- åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ 28 å¤©è®¡åˆ’ ----
function createNewPlan() {
  const arr = [];
  for (let i = 1; i <= TOTAL; i++) {
    arr.push({
      day: i,
      done: false,
      time: ""
    });
  }
  return arr;
}

// ---- æ¸²æŸ“è®¡åˆ’ ----
function renderPlan() {
  const area = document.getElementById("planArea");
  area.innerHTML = "";

  plan.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "dayBox";
    if (item.done) div.classList.add("done");

    div.innerHTML = `
      <div>
        <strong>ç¬¬ ${item.day} å¤©</strong><br>
        <small>${item.time ? "å®Œæˆæ—¶é—´ï¼š" + item.time : "æœªå®Œæˆ"}</small>
      </div>
      <div>
        <input type="checkbox" ${item.done ? "checked" : ""} data-index="${index}">
      </div>
    `;

    area.appendChild(div);
  });

  updateStats();
}

// ---- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ ----
function updateStats() {
  const done = plan.filter(p => p.done).length;
  const left = TOTAL - done;
  const percent = Math.round(done / TOTAL * 100);

  doneCount.innerText = done;
  leftCount.innerText = left;
  percent.innerText = percent;
}

// ---- ç‚¹å‡»å¤é€‰æ¡†ï¼šä¿å­˜äº‘ç«¯ ----
async function toggleDay(index) {
  const item = plan[index];
  item.done = !item.done;

  if (item.done) {
    item.time = new Date().toLocaleString();
  } else {
    item.time = "";
  }

  // äº‘åŒæ­¥
  await save("plan28", uid, { days: plan });

  renderPlan();
}

// ---- è‡ªåŠ¨åŒ¿åç™»å½• ----
autoLogin();

// ---- åŠ è½½äº‘ç«¯æ•°æ® ----
onUser(async (user) => {
  if (!user) return;
  uid = user.uid;
  uidShort.innerText = uid.slice(0, 6);

  // è¯»å–äº‘ç«¯ plan28
  const data = await load("plan28", uid);
  if (data.days) {
    plan = data.days;
  } else {
    plan = createNewPlan();
    // å†™å…¥äº‘ç«¯åˆå§‹åŒ–
    await save("plan28", uid, { days: plan });
  }

  renderPlan();
});

// ---- ç›‘å¬å¤é€‰æ¡†ç‚¹å‡» ----
document.addEventListener("change", (e) => {
  if (e.target.type === "checkbox") {
    const index = parseInt(e.target.dataset.index);
    toggleDay(index);
  }
});
</script>

</body>
</html>
