<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<title>ğŸ“Š å­¦ä¹ æ•°æ®ä»ªè¡¨æ¿ | Sylvia Deutsch Platform</title>
<link rel="stylesheet" href="../assets/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.container { max-width: 1000px; margin:auto; padding:16px; }
.card { background:#fafafa; border:1px solid #ddd; padding:16px; border-radius:12px; margin-bottom:20px; }
h2, h3 { margin-bottom:10px; }
.chartBox { width:100%; height:320px; }
.small { font-size:13px; color:#666; }
.row { display:flex; gap:20px; flex-wrap:wrap; }
.box50 { flex:1 1 calc(50% - 20px); }
@media(max-width:700px){ .box50 { flex:1 1 100%; } }
</style>
  <link rel="stylesheet" href="../assets/style.css">

</head>

<body>
<div class="container">
  <a href="../index.html" class="back">â† è¿”å›é¦–é¡µ</a>
  <h2>ğŸ“Š Sylvia çš„å­¦ä¹ æ•°æ®ä»ªè¡¨æ¿</h2>
  <p class="small">æ‰€æœ‰å›¾è¡¨éƒ½æ¥è‡ªä½ çš„ Firestore äº‘ç«¯æ•°æ®ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰ã€‚</p>

  <!-- 1. å­¦ä¹ è®¡åˆ’å®Œæˆæƒ…å†µ -->
  <div class="card">
    <h3>ğŸ“… 28å¤©å­¦ä¹ è¿›åº¦ï¼ˆå®Œæˆ vs æœªå®Œæˆï¼‰</h3>
    <div class="chartBox">
      <canvas id="planChart"></canvas>
    </div>
  </div>

  <div class="row">
    <!-- 2. è¯æ±‡ç»Ÿè®¡ -->
    <div class="card box50">
      <h3>ğŸ“š è¯æ±‡ç³»ç»Ÿç»Ÿè®¡</h3>
      <div class="chartBox">
        <canvas id="vocabChart"></canvas>
      </div>
    </div>

    <!-- 3. è¯­æ³•ç»Ÿè®¡ -->
    <div class="card box50">
      <h3>ğŸ“• è¯­æ³•ç»ƒä¹ æ­£ç¡®ç‡</h3>
      <div class="chartBox">
        <canvas id="grammarChart"></canvas>
      </div>
    </div>
  </div>

  <!-- 4. æ¯æ—¥å­¦ä¹ æ´»åŠ¨æŸ±çŠ¶å›¾ï¼ˆä» stats/uid åŠ è½½ï¼‰ -->
  <div class="card">
    <h3>â± æ¯æ—¥å­¦ä¹ æ´»åŠ¨ï¼ˆä»»åŠ¡å®Œæˆæ•°ï¼‰</h3>
    <div class="chartBox">
      <canvas id="dailyChart"></canvas>
    </div>
  </div>

</div>

<script type="module">
import { autoLogin, onUser, load } from "../assets/firebase.js";

// å›¾è¡¨å˜é‡
let planChart, vocabChart, grammarChart, dailyChart;

// è‡ªåŠ¨åŒ¿åç™»å½•
autoLogin();

onUser(async (user) => {
  if (!user) return;
  const uid = user.uid;

  // ä»äº‘ç«¯åŠ è½½å„æ¨¡å—æ•°æ®
  const plan = await load("plan28", uid) || {};
  const vocab = await load("vocab", uid) || {};
  const grammar = await load("grammar", uid) || {};
  const stats = await load("stats", uid) || {}; // future daily record

  // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
  renderPlanChart(plan);
  renderVocabChart(vocab);
  renderGrammarChart(grammar);
  renderDailyChart(stats);
});


// ---------------------------
// 1ï¼‰28 å¤©å­¦ä¹ è®¡åˆ’å›¾è¡¨
// ---------------------------
function renderPlanChart(plan) {
  const labels = [];
  const data = [];

  for (let i = 1; i <= 28; i++) {
    labels.push("Day " + i);
    data.push(plan["day" + i] ? 1 : 0);
  }

  planChart = new Chart(document.getElementById("planChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "å®Œæˆæƒ…å†µï¼ˆ1=å®Œæˆï¼Œ0=æœªå®Œæˆï¼‰",
        data,
        backgroundColor: data.map(v => v === 1 ? "rgba(75,192,192,0.6)" : "rgba(200,200,200,0.6)"),
      }]
    },
    options: { responsive: true }
  });
}


// ---------------------------
// 2ï¼‰è¯æ±‡ç³»ç»Ÿç»Ÿè®¡å›¾ï¼šæ–°è¯/å¤ä¹ /å·²æŒæ¡
// ---------------------------
function renderVocabChart(vocab) {
  const countNew = vocab.newWords ? vocab.newWords.length : 0;
  const countReview = vocab.reviewWords ? vocab.reviewWords.length : 0;
  const countMastered = vocab.mastered ? vocab.mastered.length : 0;

  vocabChart = new Chart(document.getElementById("vocabChart"), {
    type: "pie",
    data: {
      labels: ["æ–°è¯", "å¾…å¤ä¹ ", "å·²æŒæ¡"],
      datasets: [{
        data: [countNew, countReview, countMastered],
        backgroundColor: [
          "rgba(255,99,132,0.6)",
          "rgba(54,162,235,0.6)",
          "rgba(75,192,192,0.6)"
        ]
      }]
    },
    options: { responsive: true }
  });
}


// ---------------------------
// 3ï¼‰è¯­æ³•ç»ƒä¹ æ­£ç¡®ç‡ï¼ˆé”™é¢˜æœ¬ï¼‰
// ---------------------------
function renderGrammarChart(grammar) {
  const wrongs = grammar.wrongs ? grammar.wrongs.length : 0;
  const correct = grammar.totalAttempt
    ? grammar.totalAttempt - wrongs
    : 0;

  grammarChart = new Chart(document.getElementById("grammarChart"), {
    type: "doughnut",
    data: {
      labels: ["æ­£ç¡®é¢˜æ•°", "é”™é¢˜æ•°"],
      datasets: [{
        data: [correct, wrongs],
        backgroundColor: [
          "rgba(75,192,192,0.6)",
          "rgba(255,99,132,0.6)"
        ]
      }]
    },
    options: { responsive: true }
  });
}


// ---------------------------
// 4ï¼‰æ¯æ—¥å­¦ä¹ æ´»åŠ¨æŸ±çŠ¶å›¾ï¼ˆstatsï¼‰
// ---------------------------
function renderDailyChart(stats) {
  const days = [];
  const counts = [];

  if (stats.days) {
    for (const d of Object.keys(stats.days)) {
      days.push(d);
      counts.push(stats.days[d]);
    }
  }

  dailyChart = new Chart(document.getElementById("dailyChart"), {
    type: "bar",
    data: {
      labels: days,
      datasets: [{
        label: "æ¯æ—¥ä»»åŠ¡å®Œæˆæ•°",
        data: counts,
        backgroundColor: "rgba(153,102,255,0.6)"
      }]
    },
    options: { responsive: true }
  });
}

</script>
</body>
</html>

