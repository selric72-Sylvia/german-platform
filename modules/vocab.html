<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ğŸ“˜ è¯æ±‡å­¦ä¹ ï¼ˆäº‘åŒæ­¥ç‰ˆï¼‰</title>
<link rel="stylesheet" href="../assets/style.css">
<style>
.card {
  border:1px solid #ddd;
  padding:16px;
  border-radius:12px;
  background:#fafafa;
  margin-top:16px;
}
.btn {
  background:#4f8cff;
  color:white;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  border:none;
}
.btn:hover { opacity:0.85; }
.row { display:flex; gap:10px; margin-top:10px; }
textarea { width:100%; padding:6px; }
</style>
</head>

<body>

<a href="../index.html" class="back">â† è¿”å›é¦–é¡µ</a>
<h2>ğŸ“˜ è¯æ±‡å­¦ä¹ ï¼ˆäº‘åŒæ­¥ï¼‰</h2>
<p>ä½ çš„äº‘åŒæ­¥ IDï¼š<span id="uidShort" style="font-weight:bold;"></span></p>

<hr>

<div>
  <label>å­¦ä¹ æ¨¡å¼ï¼š</label>
  <select id="mode">
    <option value="new">æ–°å­¦å•è¯</option>
    <option value="review">å¤ä¹ å•è¯</option>
    <option value="all">å…¨éƒ¨å•è¯</option>
  </select>
</div>

<div class="card">
  <h2 id="word">åŠ è½½ä¸­...</h2>
  <p><strong>è¯æ€§ï¼š</strong> <span id="pos"></span></p>
  <p><strong>é‡Šä¹‰ï¼š</strong> <span id="meaning"></span></p>
  <p><strong>ä¾‹å¥ï¼š</strong><br><span id="example"></span></p>
  <p><strong>è¯ç»„ï¼š</strong><br><span id="phrase"></span></p>

  <div class="row">
    <button class="btn" id="known">æˆ‘è®°ä½äº†</button>
    <button class="btn" id="next">ä¸‹ä¸€ä¸ª</button>
  </div>
</div>

<h3>ğŸ“¥ å¯¼å…¥æ–°å•è¯ï¼ˆè‡ªåŠ¨äº‘åŒæ­¥ï¼‰</h3>
<p>æ ¼å¼ï¼ˆæ¯è¡Œä¸€æ¡ï¼Œç”¨ç«–çº¿åˆ†éš”ï¼‰ï¼š  
word | pos | meaning | example | phrase</p>

<textarea id="input" rows="6"></textarea>
<button class="btn" id="importBtn">å¯¼å…¥</button>

<script type="module">
import { autoLogin, onUser, load, save } from "../assets/firebase.js";

let uid = null;

// æ•°æ®åŒº
let base = [];     // data/vocab.json
let cloud = [];    // cloud words
let known = [];    // cloud known words
let vocab = [];    // merged vocab
let filtered = []; // current mode list
let idx = 0;

// ---- è½½å…¥åŸºç¡€ vocab.json ----
async function loadBase() {
  try {
    const resp = await fetch("../data/vocab.json");
    base = await resp.json(); // æ•°ç»„
  } catch {
    base = [];
  }
}

// ---- åˆå¹¶åŸºç¡€è¯åº“ + äº‘ç«¯è‡ªå®šä¹‰ ----
function merge() {
  const map = new Map();
  base.forEach(w => map.set(w.word, { ...w }));
  cloud.forEach(w => map.set(w.word, { ...map.get(w.word), ...w }));
  vocab = Array.from(map.values());
}

// ---- åˆ‡æ¢å­¦ä¹ æ¨¡å¼ ----
function refreshList() {
  const mode = document.getElementById("mode").value;
  if (mode === "new") {
    filtered = vocab.filter(w => !known.includes(w.word));
  } else if (mode === "review") {
    filtered = vocab.filter(w => known.includes(w.word));
  } else {
    filtered = [...vocab];
  }
  idx = 0;
}

// ---- æ˜¾ç¤ºå•è¯å¡ ----
function show() {
  if (filtered.length === 0) {
    word.innerText = "ï¼ˆè¯¥åˆ†ç±»æ— å•è¯ï¼‰";
    pos.innerText = "";
    meaning.innerText = "";
    example.innerText = "";
    phrase.innerText = "";
    return;
  }
  if (idx >= filtered.length) idx = 0;
  const w = filtered[idx];
  word.innerText = w.word;
  pos.innerText = w.pos || "";
  meaning.innerText = w.meaning || "";
  example.innerText = w.example || "ï¼ˆæ— ä¾‹å¥ï¼‰";
  phrase.innerText = w.phrase || "ï¼ˆæ— è¯ç»„ï¼‰";
}

// ---- ä¸‹ä¸€ä¸ª ----
function next() {
  idx = (idx + 1) % filtered.length;
  show();
}

// ---- æ ‡è®°å·²æŒæ¡ï¼ˆå†™äº‘ç«¯ï¼‰ ----
async function markKnown() {
  const w = filtered[idx];
  if (!w) return;

  if (!known.includes(w.word)) known.push(w.word);

  await save("vocab", uid, {
    words: cloud,
    known: known
  });

  refreshList();
  show();
  alert("å·²åŒæ­¥åˆ°äº‘ç«¯ï¼");
}

// ---- å¯¼å…¥æ–°å•è¯ ----
async function importWords() {
  const text = document.getElementById("input").value.trim();
  if (!text) return alert("è¯·è¾“å…¥å†…å®¹");

  const lines = text.split("\n").map(s => s.trim()).filter(Boolean);
  let count = 0;

  for (const line of lines) {
    const parts = line.split("|").map(s => s.trim());
    if (parts.length < 5) continue;

    const obj = {
      word: parts[0],
      pos: parts[1],
      meaning: parts[2],
      example: parts[3],
      phrase: parts[4]
    };

    const idx = cloud.findIndex(x => x.word === obj.word);
    if (idx >= 0) cloud[idx] = obj;
    else cloud.push(obj);

    count++;
  }

  await save("vocab", uid, {
    words: cloud,
    known: known
  });

  merge();
  refreshList();
  show();

  alert("å·²å¯¼å…¥å¹¶åŒæ­¥ï¼š" + count + " ä¸ªå•è¯");
}

// ---- è‡ªåŠ¨åŒ¿åç™»å½• ----
autoLogin();

// ---- ç”¨æˆ·è¿›å…¥é¡µé¢åï¼šåŠ è½½äº‘æ•°æ® ----
onUser(async (user) => {
  if (!user) return;
  uid = user.uid;
  document.getElementById("uidShort").innerText = uid.slice(0, 6);

  // 1) base
  await loadBase();

  // 2) cloud data
  const data = await load("vocab", uid);
  cloud = data.words || [];
  known = data.known || [];

  // 3) åˆå¹¶
  merge();

  // 4) æ ¹æ®æ¨¡å¼è¿‡æ»¤
  refreshList();
  show();
});

// ---- äº‹ä»¶ç»‘å®š ----
document.getElementById("next").onclick = next;
document.getElementById("known").onclick = markKnown;
document.getElementById("importBtn").onclick = importWords;

document.getElementById("mode").onchange = () => {
  refreshList();
  show();
};
</script>

</body>
</html>
