<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<title>ğŸ“• è¯­æ³•ç»ƒä¹ ï¼ˆäº‘åŒæ­¥ï¼‰</title>
<link rel="stylesheet" href="../assets/style.css">
<style>
.container { max-width:900px; margin:auto; padding:16px; }
.controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
.btn { padding:8px 12px; background:#4f8cff; color:#fff; border-radius:6px; border:none; cursor:pointer; }
.card { background:#fafafa; border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:12px; }
.qbox { margin:8px 0; }
.input { width:100%; padding:8px; margin-top:6px; }
.small { font-size:13px; color:#666; }
.option { padding:8px; border:1px solid #ddd; border-radius:6px; margin:6px 0; cursor:pointer; background:#f4f7ff; }
.option.correct { background:#c9f7d6; }
.option.wrong { background:#ffd4d4; }
.badge { display:inline-block; padding:4px 8px; background:#eee; border-radius:6px; margin-left:8px; }
</style>
</head>
<body>
<div class="container">
  <a href="../index.html" class="back">â† è¿”å›é¦–é¡µ</a>
  <h2>ğŸ“• è¯­æ³•ç»ƒä¹ ï¼ˆäº‘åŒæ­¥ï¼‰</h2>
  <p class="small">é¢˜åº“æ¥æºï¼š<code>data/grammar.json</code>ï¼ˆå¯è‡ªè¡Œæ‰©å……ï¼‰ã€‚åšé”™çš„é¢˜ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ä½ çš„äº‘ç«¯é”™é¢˜æœ¬ï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥ã€‚</p>

  <div class="card">
    <div class="controls">
      <label>é¢˜æ•°ï¼š
        <select id="numQ">
          <option>5</option><option>8</option><option>10</option><option>15</option>
        </select>
      </label>

      <label>é¢˜å‹ï¼š
        <select id="qtype">
          <option value="mixed">æ··åˆï¼ˆé»˜è®¤ï¼‰</option>
          <option value="trans">ç¿»è¯‘ï¼ˆå¾·â†’ä¸­/ä¸­â†’å¾·ï¼‰</option>
          <option value="fill">å¡«ç©º</option>
          <option value="mcq">é€‰æ‹©é¢˜ï¼ˆå¤šé¡¹é€‰æ‹©ï¼‰</option>
        </select>
      </label>

      <button class="btn" id="genBtn">ç”Ÿæˆé¢˜ç›®</button>
      <button class="btn" id="startOver" style="background:#777">é‡ç½®é”™é¢˜æœ¬</button>
    </div>

    <div id="exerciseArea"></div>
  </div>

  <div class="card">
    <h3>ğŸ“Œ é”™é¢˜æœ¬ï¼ˆäº‘ç«¯ï¼‰ <span class="badge" id="wrongCount">0</span></h3>
    <div id="wrongList"></div>
    <p class="small">ç‚¹å‡»â€œæ ‡è®°å·²è§£å†³â€ä¼šä»äº‘ç«¯åˆ é™¤è¯¥æ¡é”™é¢˜ã€‚</p>
  </div>

</div>

<script type="module">
import { autoLogin, onUser, load, save } from "../assets/firebase.js";

// å…¨å±€å˜é‡
let uid = null;
let baseQuestions = [];   // data/grammar.json
let cloudWrongs = [];     // ä»äº‘ç«¯åŠ è½½çš„é”™é¢˜ï¼ˆæ•°ç»„ï¼‰
let pool = [];            // å½“å‰ç»ƒä¹ é¢˜æ± ï¼ˆåˆå¹¶ base + cloudWrongs ä¼˜å…ˆï¼‰
let currentSession = [];  // æœ¬æ¬¡ç”Ÿæˆçš„é—®é¢˜å¯¹è±¡ï¼š{ id, q, answer, choices? }
let pointer = 0;

// è½½å…¥æœ¬åœ°é¢˜åº“
async function loadBase() {
  try {
    const res = await fetch("../data/grammar.json");
    baseQuestions = await res.json();
  } catch (e) {
    baseQuestions = [];
    console.warn("æ— æ³•åŠ è½½ data/grammar.json:", e);
  }
}

// åˆå¹¶é”™é¢˜åˆ°ç»ƒä¹ æ± ï¼ˆäº‘ç«¯é”™é¢˜ä¼˜å…ˆï¼‰
function buildPool(qtype) {
  const mix = [];

  // 1) å…ˆæŠŠäº‘ç«¯é”™é¢˜æ”¾å…¥ï¼ˆæœ‰åŠ©å¤ä¹ ï¼‰
  for (const w of cloudWrongs) {
    // ensure structure: {id, prompt, answer, type}
    mix.push({ id: w.id || ('w-'+Math.random().toString(36).slice(2,8)), prompt: w.prompt, answer: w.answer, type: w.type || 'saved' , source: 'wrong' });
  }

  // 2) ç„¶æŠŠåŸºç¡€é¢˜åº“æŒ‰ç±»å‹ç­›é€‰æˆ–éšæœºåŠ å…¥
  const candidates = baseQuestions.filter(x => {
    if (!qtype || qtype === 'mixed') return true;
    return x.type === qtype;
  });

  // éšæœºæ‰“ä¹±å¹¶æ·»åŠ 
  const shuffled = candidates.sort(() => Math.random() - 0.5);
  shuffled.forEach(s => {
    mix.push({ id: s.id || ('b-'+Math.random().toString(36).slice(2,8)), prompt: s.prompt, answer: s.answer, type: s.type || 'base', choices: s.choices || null, source: 'base' });
  });

  pool = mix;
}

// ç”Ÿæˆé¢˜ç›®ï¼ˆä» pool å–å‰ nï¼‰
function generate(n, qtype) {
  buildPool(qtype);
  currentSession = pool.slice(0, n).map(item => ({ ...item }));
  pointer = 0;
  renderQuestionArea();
}

// æ¸²æŸ“é¢˜ç›®åŒºï¼ˆé€é¢˜æ˜¾ç¤ºè¾“å…¥æ¡†æˆ–é€‰é¡¹ï¼‰
function renderQuestionArea() {
  const area = document.getElementById("exerciseArea");
  area.innerHTML = "";

  if (!currentSession || currentSession.length === 0) {
    area.innerHTML = "<p class='small'>è¯·å…ˆç”Ÿæˆé¢˜ç›®ã€‚</p>";
    return;
  }

  const qObj = currentSession[pointer];
  const idxText = `<div class="small">ç¬¬ ${pointer+1} / ${currentSession.length} é¢˜ï¼ˆæ¥æºï¼š${qObj.source}ï¼‰</div>`;
  let html = `<div class="qbox">${idxText}<p><strong>${qObj.prompt}</strong></p>`;

  if (qObj.choices && qObj.choices.length > 0) {
    // å¤šé€‰é¢˜
    html += `<div id="choices">`;
    qObj.choices.forEach((c, i) => {
      html += `<div class="option" data-opt="${c}">${c}</div>`;
    });
    html += `</div>`;
    html += `<div style="margin-top:8px"><button class="btn" id="skipBtn">è·³è¿‡ / ä¸‹ä¸€é¢˜</button></div>`;
  } else {
    // å¡«ç©ºæˆ–ç¿»è¯‘ï¼ˆæ–‡æœ¬è¾“å…¥ï¼‰
    html += `<input id="answerInput" class="input" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç­”æ¡ˆ">`;
    html += `<div style="margin-top:8px"><button class="btn" id="submitBtn">æäº¤ç­”æ¡ˆ</button> <button class="btn" id="skipBtn" style="background:#777">è·³è¿‡</button></div>`;
  }

  html += `<div id="feedback" style="margin-top:10px;"></div>`;
  html += `</div>`;

  area.innerHTML = html;

  // ç»‘å®šäº‹ä»¶
  if (qObj.choices && qObj.choices.length > 0) {
    document.querySelectorAll("#choices .option").forEach(el => {
      el.onclick = () => handleChoice(el, qObj);
    });
    document.getElementById("skipBtn").onclick = nextQuestion;
  } else {
    document.getElementById("submitBtn").onclick = () => handleSubmit(qObj);
    document.getElementById("skipBtn").onclick = nextQuestion;
  }
}

// å¤„ç†é€‰æ‹©é¢˜ç‚¹å‡»
function handleChoice(el, qObj) {
  const val = el.dataset.opt;
  const correct = qObj.answer;
  if (val === correct) {
    el.classList.add("correct");
    showFeedback(true, correct);
    setTimeout(nextQuestion, 700);
  } else {
    el.classList.add("wrong");
    // é«˜äº®æ­£ç¡®
    document.querySelectorAll("#choices .option").forEach(o => {
      if (o.dataset.opt === correct) o.classList.add("correct");
    });
    showFeedback(false, correct);
    // ä¿å­˜é”™é¢˜
    saveWrong(qObj, val);
    setTimeout(nextQuestion, 1200);
  }
}

// å¤„ç†æ–‡æœ¬æäº¤
function handleSubmit(qObj) {
  const user = document.getElementById("answerInput").value.trim();
  const correct = qObj.answer.trim();

  if (!user) {
    alert("è¯·å…ˆè¾“å…¥ç­”æ¡ˆæˆ–ç‚¹å‡»è·³è¿‡");
    return;
  }

  // ç®€å•æ¯”è¾ƒï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰ï¼Œä¹Ÿå¯ä»¥æ‰©å±•ä¸ºè¿‘ä¼¼åŒ¹é…
  if (user.toLowerCase() === correct.toLowerCase()) {
    showFeedback(true, correct);
    setTimeout(nextQuestion, 700);
  } else {
    showFeedback(false, correct);
    saveWrong(qObj, user);
    setTimeout(nextQuestion, 1200);
  }
}

// æ˜¾ç¤ºåé¦ˆ
function showFeedback(isCorrect, correctAns) {
  const fb = document.getElementById("feedback");
  if (isCorrect) fb.innerHTML = `<span style="color:green">âœ” æ­£ç¡®</span>`;
  else fb.innerHTML = `<span style="color:red">âœ˜ é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆï¼š<strong>${correctAns}</strong></span>`;
}

// ä¸‹ä¸€é¢˜
function nextQuestion() {
  if (pointer < currentSession.length - 1) {
    pointer++;
    renderQuestionArea();
  } else {
    // æœ¬æ¬¡ç»ƒä¹ å®Œæˆ
    document.getElementById("exerciseArea").innerHTML = `<p class="small">ç»ƒä¹ å®Œæˆï¼ä½ å¯ä»¥ç”Ÿæˆæ–°ä¸€è½®é¢˜ç›®ã€‚</p>`;
    // æ›´æ–°é”™é¢˜æœ¬è®¡æ•°æ˜¾ç¤º
    refreshWrongList();
  }
}

// å°†åšé”™çš„é—®é¢˜å­˜å…¥äº‘ç«¯é”™é¢˜æœ¬ï¼ˆcollection: grammar; doc: uidï¼‰
async function saveWrong(qObj, userAnswer) {
  if (!uid) return;
  const wrongEntry = {
    id: qObj.id || ('g-'+Math.random().toString(36).slice(2,8)),
    prompt: qObj.prompt,
    answer: qObj.answer,
    type: qObj.type || 'unknown',
    userAnswer: userAnswer,
    date: new Date().toLocaleString()
  };

  // å°†æ­¤æ¡åŠ å…¥ cloudWrongsï¼ˆè‹¥å·²æœ‰ç›¸åŒ id åˆ™æ›´æ–°ï¼‰
  const ex = cloudWrongs.findIndex(x => x.id === wrongEntry.id);
  if (ex >= 0) {
    cloudWrongs[ex] = wrongEntry;
  } else {
    cloudWrongs.unshift(wrongEntry); // å‰ç½®ï¼Œä¼˜å…ˆå¤ä¹ 
  }

  // å†™å›äº‘ç«¯
  await save("grammar", uid, { wrongs: cloudWrongs });
  refreshWrongList();
}

// åŠ è½½äº‘ç«¯é”™é¢˜å¹¶æ¸²æŸ“åˆ—è¡¨
async function refreshWrongList() {
  const el = document.getElementById("wrongList");
  el.innerHTML = "";
  const countBadge = document.getElementById("wrongCount");
  countBadge.innerText = cloudWrongs.length;

  if (cloudWrongs.length === 0) {
    el.innerHTML = "<p class='small'>ä½ çš„é”™é¢˜æœ¬ä¸ºç©ºã€‚</p>";
    return;
  }

  cloudWrongs.forEach((w, i) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<div><strong>${w.prompt}</strong></div>
      <div class="small">æ­£ç¡®ç­”æ¡ˆï¼š${w.answer} &nbsp; <span style="margin-left:12px">ä½ çš„ç­”æ¡ˆï¼š${w.userAnswer || 'â€”'}</span></div>
      <div class="small">è®°å½•æ—¶é—´ï¼š${w.date}</div>
      <div style="margin-top:8px">
        <button class="btn" data-i="${i}" data-id="${w.id}">æ ‡è®°å·²è§£å†³</button>
      </div>`;
    el.appendChild(div);
  });

  // ç»‘å®šåˆ é™¤ï¼ˆæ ‡è®°å·²è§£å†³ï¼‰
  el.querySelectorAll("button[data-i]").forEach(btn => {
    btn.onclick = async (e) => {
      const i = parseInt(btn.getAttribute("data-i"));
      const id = btn.getAttribute("data-id");
      // ä» cloudWrongs åˆ é™¤
      cloudWrongs = cloudWrongs.filter(x => x.id !== id);
      await save("grammar", uid, { wrongs: cloudWrongs });
      refreshWrongList();
      alert("å·²æ ‡è®°ä¸ºå·²è§£å†³å¹¶åŒæ­¥äº‘ç«¯");
    };
  });
}

// é‡ç½®é”™é¢˜æœ¬ï¼ˆå°å¿ƒä½¿ç”¨ï¼‰
document.getElementById("startOver").onclick = async () => {
  if (!confirm("ç¡®è®¤æ¸…ç©ºäº‘ç«¯é”™é¢˜æœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
  cloudWrongs = [];
  await save("grammar", uid, { wrongs: [] });
  refreshWrongList();
  alert("é”™é¢˜æœ¬å·²æ¸…ç©º");
};

// ç”Ÿæˆé¢˜ç›®æŒ‰é’®
document.getElementById("genBtn").onclick = () => {
  const n = parseInt(document.getElementById("numQ").value);
  const qtype = document.getElementById("qtype").value;
  generate(n, qtype);
};

// åŒ¿åè‡ªåŠ¨ç™»å½•å¹¶åŠ è½½äº‘ç«¯æ•°æ®
autoLogin();
onUser(async (user) => {
  if (!user) return;
  uid = user.uid;

  // 1) åŠ è½½åŸºç¡€é¢˜åº“
  await loadBase();

  // 2) åŠ è½½äº‘ç«¯é”™é¢˜
  const data = await load("grammar", uid);
  cloudWrongs = data.wrongs || [];

  // 3) åˆå§‹æ˜¾ç¤ºé”™é¢˜åˆ—è¡¨
  refreshWrongList();
});
</script>
</body>
</html>
