<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>è¯æ±‡æµ‹è¯•ç³»ç»Ÿ</title>
<link rel="stylesheet" href="../assets/style.css">
<style>
.card {
    border: 1px solid #ccc;
    padding: 20px;
    border-radius: 12px;
    background: #fafafa;
    margin-bottom: 20px;
}
.option {
    padding: 12px;
    border: 1px solid #ccc;
    margin: 8px 0;
    border-radius: 6px;
    cursor: pointer;
}
.option:hover { background: #e7f1ff; }
.correct { background: #c0f7c0 !important; }
.wrong { background: #ffc0c0 !important; }
.btn-row { display: flex; gap: 10px; margin-top: 15px; }
.btn-mini {
    padding: 10px;
    background: #4f8cff;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    flex: 1;
}
.btn-mini:hover { background: #3d74d8; }
</style>
</head>

<body>

<a href="vocab.html" class="back">â† è¿”å›è¯æ±‡å­¦ä¹ </a>
<h2>ğŸ“ è¯æ±‡æµ‹è¯•ç³»ç»Ÿ</h2>

<div>
    <label>é€‰æ‹©æµ‹è¯•æ¨¡å¼ï¼š</label>
    <select id="testMode">
        <option value="spell">æ‹¼å†™æµ‹è¯•</option>
        <option value="choice">é€‰æ‹©æµ‹è¯•</option>
    </select>
</div>

<div class="card" id="testArea">
    <h3 id="question">åŠ è½½ä¸­...</h3>

    <!-- æ‹¼å†™æ¨¡å¼ -->
    <div id="spellMode">
        <input id="spellInput" type="text" style="width:100%; padding:10px;">
        <div class="btn-mini" onclick="checkSpell()">æäº¤ç­”æ¡ˆ</div>
    </div>

    <!-- é€‰æ‹©é¢˜æ¨¡å¼ -->
    <div id="choiceMode" style="display:none;">
        <div id="options"></div>
    </div>

    <hr>
    <p><strong>ä¾‹å¥ï¼š</strong> <span id="ex"></span></p>
    <p><strong>è¯ç»„ï¼š</strong> <span id="ph"></span></p>

    <div class="btn-row">
        <div class="btn-mini" onclick="nextQuestion()">ä¸‹ä¸€ä¸ª</div>
        <div class="btn-mini" onclick="resetStats()">æ¸…ç©ºç»Ÿè®¡</div>
    </div>
</div>

<h3>ğŸ“Š æµ‹è¯•ç»Ÿè®¡</h3>
<p>æ€»é¢˜æ•°ï¼š<span id="totalNum">0</span></p>
<p>ç­”å¯¹ï¼š<span id="correctNum">0</span></p>
<p>æ­£ç¡®ç‡ï¼š<span id="percent">0%</span></p>

<script>
let vocab = [];
let current;
let total = Number(localStorage.getItem("test_total") || 0);
let correct = Number(localStorage.getItem("test_correct") || 0);

document.getElementById("totalNum").innerText = total;
document.getElementById("correctNum").innerText = correct;

async function loadData() {
    const res = await fetch("../data/vocab.json");
    vocab = await res.json();
    nextQuestion();
}

document.getElementById("testMode").addEventListener("change", () => {
    const mode = document.getElementById("testMode").value;
    document.getElementById("spellMode").style.display = (mode === "spell") ? "block" : "none";
    document.getElementById("choiceMode").style.display = (mode === "choice") ? "block" : "none";
    nextQuestion();
});

function nextQuestion() {
    current = vocab[Math.floor(Math.random() * vocab.length)];

    document.getElementById("question").innerText =
        `è¯·ç»™å‡ºå•è¯ï¼š**${current.meaning}**`;
    
    document.getElementById("ex").innerText = current.example || "ï¼ˆæ— ä¾‹å¥ï¼‰";
    document.getElementById("ph").innerText = current.phrase || "ï¼ˆæ— è¯ç»„ï¼‰";

    // æ‹¼å†™æ¨¡å¼
    document.getElementById("spellInput").value = "";

    // é€‰æ‹©é¢˜æ¨¡å¼
    if (document.getElementById("testMode").value === "choice") {
        generateChoices();
    }
}

function generateChoices() {
    let optionsDiv = document.getElementById("options");
    optionsDiv.innerHTML = "";

    let choices = [current.word];
    while (choices.length < 4) {
        let w = vocab[Math.floor(Math.random() * vocab.length)].word;
        if (!choices.includes(w)) choices.push(w);
    }

    choices.sort(() => Math.random() - 0.5);

    for (let word of choices) {
        let div = document.createElement("div");
        div.className = "option";
        div.innerText = word;
        div.onclick = () => checkChoice(div, word);
        optionsDiv.appendChild(div);
    }
}

function checkSpell() {
    let ans = document.getElementById("spellInput").value.trim();
    markResult(ans === current.word);
}

function checkChoice(div, word) {
    let all = document.querySelectorAll(".option");
    for (let o of all) o.style.pointerEvents = "none";

    if (word === current.word) {
        div.classList.add("correct");
        markResult(true, false);
    } else {
        div.classList.add("wrong");
        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
        for (let o of all) {
            if (o.innerText === current.word) o.classList.add("correct");
        }
        markResult(false, false);
    }
}

function markResult(isCorrect, isSpell = true) {
    total++;
    if (isCorrect) correct++;

    localStorage.setItem("test_total", total);
    localStorage.setItem("test_correct", correct);

    document.getElementById("totalNum").innerText = total;
    document.getElementById("correctNum").innerText = correct;
    document.getElementById("percent").innerText =
        Math.round(correct / total * 100) + "%";
}

function resetStats() {
    total = 0;
    correct = 0;
    localStorage.setItem("test_total", 0);
    localStorage.setItem("test_correct", 0);

    document.getElementById("totalNum").innerText = 0;
    document.getElementById("correctNum").innerText = 0;
    document.getElementById("percent").innerText = "0%";
}

loadData();
</script>

</body>
</html>
